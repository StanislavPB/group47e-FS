# Lesson 17


## Spring Security

## 01. Безопасность в приложении


* `Aутентификация` - идентификация пользователя, кто ты?
* Аутентификация - процесс, при котором приложение запрашивает логин и пароль и проверяет их корректность (проверка подлинности данных пользователя)


* `Авторизация` - проверка прав пользователя, какие действия ты можешь выполнять?
* Авторизация - процесс, при котором приложение проверяет права пользователя на выполнение каких-либо операций
    * например, проверка на возможность получения пользователем всех курсов по адресу `/courses`

* HTTP-сессия - это некоторый объект, который мы храним на сервере, с которым может быть ассоциирован конкретный пользователь

## 02. Процесс аутентификации на основе сессии

* Сначала клиент отправляет POST-запрос на сервер по адресу `api/login`
* В теле запроса клиент передает данные для аутентификации (например, email и пароль)
* Сервер проверяет корректность этих данных (находит пользователя в базе, хеширует введенный пароль, сравнивает с тем, который есть в базе)
* Если данные для входа корректные, то сервер в оперативной памяти создает объект сессии
    * ассоциирует с этим объектом данные пользователя
    * назначает объекту идентификатор
    * отправляет клиенту этот идентификатор, который на клиенте сохраняется в куках

## 03. Процесс авторизации на основе сессии

* Клиент посылает свой запрос вместе с кукой, которая содержит идентификатор сессии
* Сервер по этому идентификатору находит сессию в хранилище и получает ее атрибуты (в нашем случае это пользователь)
* Получив пользователя, сервер проверяет его роль и доступ к определенному endpoint на основе правил (опишем далее)
* Клиенту возвращается либо запрошенный ресурс, либо 403-статус (Запрещено)


## 04. Настройка безопасности Spring Boot с Spring Security

* При подключении Spring Boot Starter Security у вас есть:
    * Страница входа
    * Защита всех endpoints
    * Логин `user`
    * Пароль генерируется в консоли
* Но мы хотим, чтобы люди заходили под своими логинами и паролями


* `Authentication` - объект, который хранит для каждого запроса информацию о пользователе и статусе его аутентификации.

* `SecurityContext` - информация о безопасности, которая ассоциирована с текущим потоком исполнения (Thread). Хранит объект Authentication.

* `SecurityContextHolder` - привязывает SecurityContext к текущему потоку исполнения. По умолчанию ThreadLocal - контекст безопосности доступен всем методам, исполняемым в рамках данного потока.

* Т.е. когда приходит запрос на сервер, сервер выделяет ему один поток из `Tomcat Thread Pool`
* Далее, SecurityContextHolder (на самом деле фильтры, но это не важно) смотрит текущую сессию и привязывает объект `Authentication` к текущему потоку исполнения
* Далее, когда запрос приходит в какой-либо контроллер или хендлер - он уже приходит с объектом аутентификации


### Шаги по настройке Spring Security


1. Создать класс-реализацию интерфейса `UserDetails`
* Данный класс нужен для того, чтобы адаптировать вашего пользователя под безопасность Spring Security
* По сути, это адаптер нашего класса `User` для `Spring Security`
2. Создать класс-реализацию интерфейса `UserDetailsService`
* Данный класс нужен для того, чтобы показать Spring Security откуда брать пользователя для проверки
3. Настройка конфигурации Spring Security
4. Навести порядок с ответами на запросы

  





